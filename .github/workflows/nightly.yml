name: Nightly pre-release binaries

on:
  schedule:
    - cron: '20 3 * * *'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

concurrency:
  group: nightly-release
  cancel-in-progress: false

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-15-intel
            target: x86_64-apple-darwin
          - os: macos-15
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libdbus-1-dev pkg-config

      - name: Build release binary
        run: cargo build --locked --release --target ${{ matrix.target }}

      - name: Smoke test binary (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          TARGET: ${{ matrix.target }}
        shell: bash
        run: |
          BIN="target/$TARGET/release/chabeau"
          "$BIN" --version
          "$BIN" --help > /dev/null

      - name: Smoke test binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $bin = "target/${{ matrix.target }}/release/chabeau.exe"
          & $bin --version
          & $bin --help | Out-Null

      - name: Package release archive (Linux/macOS)
        if: runner.os != 'Windows'
        env:
          TARGET: ${{ matrix.target }}
        shell: bash
        run: |
          set -euo pipefail
          BIN_DIR="target/$TARGET/release"
          ASSET_TARGET="$TARGET"
          ASSET_TARGET="${ASSET_TARGET/-unknown-/-}"
          ARCHIVE="chabeau-nightly-$ASSET_TARGET.tar.gz"
          tar -C "$BIN_DIR" -czf "$ARCHIVE" chabeau
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "$ARCHIVE" > "$ARCHIVE.sha256"
          else
            shasum -a 256 "$ARCHIVE" > "$ARCHIVE.sha256"
          fi

      - name: Package release archive (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $assetTarget = "${{ matrix.target }}".Replace("-pc-", "-")
          $archive = "chabeau-nightly-$assetTarget.zip"
          Compress-Archive -Path "target/${{ matrix.target }}/release/chabeau.exe" -DestinationPath $archive -Force
          $hash = (Get-FileHash -Algorithm SHA256 $archive).Hash.ToLower()
          "$hash  $archive" | Out-File -Encoding ascii "$archive.sha256"

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nightly-${{ matrix.target }}
          path: |
            chabeau-nightly-*.tar.gz
            chabeau-nightly-*.tar.gz.sha256
            chabeau-nightly-*.zip
            chabeau-nightly-*.zip.sha256

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: nightly-*
          merge-multiple: false

      - name: Build combined checksum file
        run: |
          set -euo pipefail
          find dist/nightly-* -type f -name 'chabeau-nightly-*.sha256' -print0 \
            | sort -z \
            | xargs -0 cat > dist/SHA256SUMS

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign checksum manifest (keyless)
        run: |
          set -euo pipefail
          cosign sign-blob --yes \
            --output-signature dist/SHA256SUMS.sig \
            --output-certificate dist/SHA256SUMS.pem \
            dist/SHA256SUMS

      - name: Move nightly tag to this commit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git tag -f nightly "$GITHUB_SHA"
          git push origin refs/tags/nightly --force

      - name: Publish or update nightly pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: Nightly
          prerelease: true
          make_latest: false
          target_commitish: ${{ github.sha }}
          body: |
            Nightly build from commit `${{ github.sha }}`.

            Artifacts include Linux, macOS, and Windows binaries with per-archive SHA-256 checksums.
            The checksum manifest is signed with keyless Sigstore via GitHub Actions OIDC.
          files: |
            dist/nightly-*/chabeau-nightly-*.tar.gz
            dist/nightly-*/chabeau-nightly-*.zip
            dist/nightly-*/chabeau-nightly-*.tar.gz.sha256
            dist/nightly-*/chabeau-nightly-*.zip.sha256
            dist/SHA256SUMS
            dist/SHA256SUMS.sig
            dist/SHA256SUMS.pem
          overwrite_files: true

      - name: Remove stale nightly assets
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const path = require("path");
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const distDir = path.join(process.env.GITHUB_WORKSPACE, "dist");

            const keep = new Set();
            for (const entry of fs.readdirSync(distDir, { withFileTypes: true })) {
              if (!entry.isDirectory()) continue;
              const dir = path.join(distDir, entry.name);
              for (const file of fs.readdirSync(dir)) {
                keep.add(file);
              }
            }
            keep.add("SHA256SUMS");
            keep.add("SHA256SUMS.sig");
            keep.add("SHA256SUMS.pem");

            const { data: release } = await github.rest.repos.getReleaseByTag({
              owner,
              repo,
              tag: "nightly",
            });

            for (const asset of release.assets) {
              if (!keep.has(asset.name)) {
                await github.rest.repos.deleteReleaseAsset({
                  owner,
                  repo,
                  asset_id: asset.id,
                });
              }
            }
